<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>RecyCool</title>
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!--[if lt IE 9]>
			<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

</head>

<body ng-app="searchModule">
    <!-- begin template -->
    <div class="navbar navbar-custom navbar-fixed-top">
        <!--        <div class="navbar-header"><a class="navbar-brand" href="#">RecyCool</a>-->
        <img class="navbar-brand" src="../images/logo.png" />

    </div>
    <div class="navbar-collapse collapse">
        <form class="navbar-form">
        </form>
    </div>

    <!--<div id="map-canvas"></div>-->
    <div class="container-fluid" id="main">

        <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12" id="left" ng-controller="searchCtrl">
                <div class="col-xs-10 col-xs-offset-1" style="text-align:center">
                    <h2><b>Where</b> would you like to recycle?</h2></div>
                <br>
                <br>
                <br>
                <br>
                <br>
                <div style="margin-left:7%">
                    <span id="searchable" class="oneSpot" style="font-size: 18px; margin-right:10px;"> Around a Spot </span>
                    <div class="toggle-button" style="background:#5cb85c" ng-click="changeDistanceToggle()">
                        <div id="toggler" class="toggle-button-switch" style="background:white"></div>
                    </div>
                    <span style="font-size: 18px; margin-left:8px;"> On my Way</span>
                </div>

                <center style="margin: 20px">
                    <div class="row">
                        <h5 ng-if="aroundASpot" class="col-xs-4"> Center Spot: </h5>
                        <h5 ng-if="!aroundASpot" class="col-xs-4"> Starting Spot: </h5>
                        <input id="fromSearch" class="col-xs-5 form-control" style="width: 50%; margin:0px;" type="text" name="firstSpot" />
                    </div>
                    <div class="row" ng-if="!aroundASpot">
                        <h5 class="col-xs-4"> Ending Spot: </h5>
                        <input id="endSearch" class="col-xs-5 form-control" style="width: 50%; margin:0px;" type="text" name="secondSpot" />
                    </div>
                </center>

                <hr>
                <span class="col-xs-10 col-xs-offset-1" style="text-align:center"><h2><b>What</b> would you like to recycle?</h2></span>

                <div class="list-group">
                    <div class="row">
                        <div class="btn col-xs-10 col-xs-offset-1" id="Cans" ng-click="isMetal = !isMetal" ng-class="{'btn-success': isMetal, 'flag': isMetal, 'btn-default': !isMetal}">
                            <img title="Recycle Aluminum Cans" alt="Recycle Aluminum Cans" src="/images/metal.png" id="1" width="50px" style="float:left">
                            <h3 class="move" style="float:left; padding-left:20px">Cans</h3>
                        </div>
                    </div>


                    <div class="row">
                        <div class="btn col-xs-10 col-xs-offset-1" id="Paper" ng-click="isPaper = !isPaper" ng-class="{'btn-success': isPaper, 'flag': isPaper, 'btn-default': !isPaper}">
                            <img title="Recycle Corrugated Cardboard" alt="Recycle Corrugated Cardboard" src="/images/paper.png" id="2" width="50px" style="float:left">
                            <h3 class="move" style="float:left; padding-left:20px">Paper/Cardboard</h3>
                        </div>
                    </div>


                    <div class="row">
                        <div class="btn col-xs-10 col-xs-offset-1" id="Glass" ng-click="isGlass = !isGlass" ng-class="{'btn-success': isGlass, 'flag': isGlass, 'btn-default': !isGlass}">
                            <img title="Recycle Glass" alt="Recycle Glass" src="/images/glass.png" id="3" width="50px" style="float:left">
                            <h3 class="move" style="float:left; padding-left:20px">Glass</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="btn col-xs-10 col-xs-offset-1" id="Plastics" ng-click="isPlastics = !isPlastics" ng-class="{'btn-success': isPlastics, 'flag': isPlastics, 'btn-default': !isPlastics}">
                            <img title="Recycle Plastic" alt="Recycle Plastic" src="/images/plastic.png" id="4" width="50px" style="float:left">
                            <h3 class="move" style="float:left; padding-left:20px">Plastics</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="btn col-xs-10 col-xs-offset-1" id="Batteries" ng-click="isBatteries = !isBatteries" ng-class="{'btn-success': isBatteries, 'flag': isBatteries, 'btn-default': !isBatteries}">
                            <img title="Recycle Lightbulbs and Batteries" alt="Recycle Lightbulbs and Batteries" src="/images/battery.png" id="5" width="50px" style="float:left">
                            <h3 class="move" style="float:left; padding-left:20px">Batteries/Bulbs</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="btn col-xs-10 col-xs-offset-1" id="Electronics" ng-click="isElectronics = !isElectronics" ng-class="{'btn-success': isElectronics, 'flag': isElectronics, 'btn-default': !isElectronics}">
                            <img title="Recycle Electronics" alt="Recycle Electronics" src="/images/electronic.png" id="6" width="50px" style="float:left">
                            <h3 class="move" style="float:left; padding-left:20px">Electronics</h3>
                        </div>
                    </div>
                </div>

                <hr>

                <center>
                    <button id="search" class="btn-lg btn-success" style="font-size:25px;"> SEARCH </button>
                </center>
            </div>
            <div id="map" class="col-lg-8 col-md-8 col-sm-8 col-xs-12">

                <!--map-canvas will be postioned here-->
            </div>
        </div>
        <div id="floating-panel">
            <b>Mode of Travel: </b>
            <select id="mode">
                <option value="DRIVING">Driving</option>
                <option value="WALKING">Walking</option>
                <option value="BICYCLING">Bicycling</option>
                <option value="TRANSIT">Transit</option>
            </select>
        </div>


    </div>
    <!--
        <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8P8osXZ3WJNqKpYHijYDv1I1A_6wIcuM&callback=initMap">
    </script>
-->
    <script>
        var markers = [];
        var markersAmir = [];
        var markersAllStations = [];
        var stations;
        var map;
        var lastDirection;

        document.getElementById('toggler').addEventListener('click', function () {
            initMap();
        });

        function initMap() {
            $("#fromSearch").val('');
            $("#endSearch").val('');
            map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: 32,
                    lng: 35
                },
                zoom: 15
            });

            $.get("/points", function (data) {
                stations = data;
            }).then(function () {
                printStations(map);
            });

            var directionsDisplay = new google.maps.DirectionsRenderer;
            var directionsService = new google.maps.DirectionsService;
            directionsDisplay.setMap(map);
            document.getElementById('mode').addEventListener('change', function () {
                findBestRoad();
            });
            var geocoder = new google.maps.Geocoder();
            google.maps.event.addListener(map, 'click', function (event) {
                placeMarker(map, event.latLng, directionsService, directionsDisplay, geocoder);
            });


            //            var infoWindow = new google.maps.InfoWindow({
            //                map: map
            //            });


            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    //            infoWindow.setPosition(pos);
                    //            infoWindow.setContent('Your Location');
                    //                    map.setCenter(pos);
                    //
                    //                    var marker = new google.maps.Marker({
                    //                        position: pos,
                    //                        url: '/',
                    //                        animation: google.maps.Animation.DROP
                    //                    });
                    //                    marker.setMap(map);
                    //                    markersAmir.push(marker);



                    document.getElementById('fromSearch').addEventListener('click', function () {
                        geocodeAddress(geocoder, map);
                    });

                    geocodeLatLngMe(geocoder, map, pos);

                    var input = (document.getElementById('fromSearch'));
                    var autocomplete = new google.maps.places.Autocomplete(input);
                    autocomplete.bindTo('bounds', map);


                    autocomplete.addListener('place_changed', function () {
                        infowindow.close();
                        marker.setVisible(false);
                        var place = autocomplete.getPlace();
                        if (!place.geometry) {
                            // User entered the name of a Place that was not suggested and
                            // pressed the Enter key, or the Place Details request failed.
                            window.alert("No details available for input: '" + place.name + "'");
                            return;
                        }

                        // If the place has a geometry, then present it on a map.
                        if (place.geometry.viewport) {
                            map.fitBounds(place.geometry.viewport);
                        } else {
                            map.setCenter(place.geometry.location);
                            map.setZoom(17); // Why 17? Because it looks good.
                        }
                        marker.setIcon( /** @type {google.maps.Icon} */ ({
                            url: place.icon,
                            size: new google.maps.Size(71, 71),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(17, 34),
                            scaledSize: new google.maps.Size(35, 35)
                        }));
                        marker.setPosition(place.geometry.location);
                        marker.setVisible(true);

                        var address = '';
                        if (place.address_components) {
                            address = [
                                (place.address_components[0] && place.address_components[0].short_name || ''),
                                (place.address_components[1] && place.address_components[1].short_name || ''),
                                (place.address_components[2] && place.address_components[2].short_name || '')].join(' ');
                        }

                        infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
                        infowindow.open(map, marker);
                    });
                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        }

        function placeMarker(map, location, directionsService, directionsDisplay, gecoder) {
            if ($("#searchable").hasClass('oneSpot')) {
                var mrarkerChaker = markersAmir.pop();
                if (mrarkerChaker != null) {
                    mrarkerChaker.setMap(null);
                }

                var mrarkerChaker = markers.pop();
                if (mrarkerChaker != null) {
                    mrarkerChaker.setMap(null);
                }

                var mrarkerChaker = markers.pop();
                if (mrarkerChaker != null) {
                    mrarkerChaker.setMap(null);
                }

                directionsDisplay.setMap(null);
                var marker = new google.maps.Marker({
                    map: map,
                    position: location,
                    type: 'images/battery.png'
                });
                markersAmir.push(marker);

                marker.setMap(map);
                geocodeLatLngToAdressSecondSearch(gecoder, map, location);
            } else if (markers.length < 2) {
                var markerChecker = markersAmir.pop();
                if (markerChecker != null) {
                    markerChecker.setMap(null);
                }
                var marker = new google.maps.Marker({
                    map: map,
                    position: location,
                    type: 'images/battery.png'
                });
                markers.push(marker);

                marker.setMap(map);

                if (markers.length == 1) {
                    geocodeLatLngToAdressSecondSearch(gecoder, map, location);
                } else {
                    geocodeLatLngToAdress(gecoder, map, location);
                }
            }



            // Removes added marker by click
            google.maps.event.addListener(marker, 'click', function () {
                this.setMap(null);
                markers.splice(markers.indexOf(this), 1);
            });
        }

        function calculateAndDisplayRoute(directionsService, directionsDisplay) {
            var selectedMode = document.getElementById('mode').value;
            directionsService.route({
                origin: {
                    lat: markers[0].getPosition().lat(),
                    lng: markers[0].getPosition().lng()
                }, // Haight.
                destination: {
                    lat: markers[1].getPosition().lat(),
                    lng: markers[1].getPosition().lng()
                },
                travelMode: google.maps.TravelMode[selectedMode]
            }, function (response, status) {
                if (status == 'OK') {
                    directionsDisplay.setDirections(response);
                    directionsDisplay.setMap(map);
                    lastDirection = directionsDisplay;
                    var time = 0;
                    var myRoute = directionsDisplay.directions.routes[0];
                    for (var i = 0; i < myRoute.legs.length; i++) {
                        time += myRoute.legs[i].duration.text;
                    }
                    sweetAlert("Master!", "time of route: " + time, "success");

                    // alert(time);
                } else {
                    //                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        function getRoadTime(startPoint, endPoint) {
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var directionsService = new google.maps.DirectionsService;
            var selectedMode = document.getElementById('mode').value;
            directionsService.route({
                origin: startPoint,
                destination: endPoint,
                travelMode: google.maps.TravelMode[selectedMode]
            }, function (response, status) {
                if (status == 'OK') {
                    directionsDisplay.setDirections(response);
                    var time = 0;
                    var myRoute = directionsDisplay.directions.routes[0];
                    for (var i = 0; i < myRoute.legs.length; i++) {
                        time += myRoute.legs[i].duration.value;
                    }
                    return time;
                } else {
                    //                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
        }

        function geocodeAddress(geocoder, resultsMap) {
            var currentMarker = markersAmir.pop();
            if (currentMarker != null) {
                currentMarker.setMap(null);
            }
            var address = document.getElementById('fromSearch').value;

            geocoder.geocode({
                'address': address
            }, function (results, status) {
                if (status === 'OK') {
                    resultsMap.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({
                        map: resultsMap,
                        position: results[0].geometry.location
                    });
                    markersAmir.push(marker);

                } else {
                    //                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        $("#search").on('click', findBestRoad);

        function findBestRoad() {
            var from = $("#fromSearch").val();
            var end = $("#endSearch").val()
            if (end == null) {
                end = from;
                var marker = markersAmir.pop();
                markers.push(marker);
                markers.push(marker);
            }
            var allTypes = document.getElementsByClassName("flag");
            var recycleTypes = [];
            for (var i = 0; i < allTypes.length; i++) {
                recycleTypes.push(allTypes[i].id);
            }
            //            $.post('/points/type', {
            //                recycleOptions: recycleTypes
            //            }).then(function (data) {
            //                allPoints = data.data;
            //                for (currPoint in allPoints) {
            //
            //                }
            //            });
            $.ajax({
                contentType: 'application/json',
                data: JSON.stringify({
                    "recycleOptions": recycleTypes
                }),
                dataType: "json",
                type: "POST",
                url: "/points/type",
                success: function (data) {









                    // START OF ALGO




                    //                    var startPoint = {
                    //                        lat: markers[0].getPosition().lat(),
                    //                        lng: markers[0].getPosition().lng()
                    //                    }
                    //                    var minTime = Number.MAX_VALUE;
                    //                    var minWayPoint
                    //                    var endPoint;
                    //                    var wayPoints = [];
                    //                    var curr
                    //                    while (recycleTypes.length > 0) {
                    //                        var curr = recycleTypes.pop();
                    //                        for (var i = 0; i < data.length; i++) {
                    //                            if (data[i].recycleOptions.indexOf(curr) != -1) {
                    //                                endPoint = {
                    //                                    lat: data[i].latitue,
                    //                                    lng: data[i].longitude
                    //                                }
                    //                                var directionsDisplay = new google.maps.DirectionsRenderer;
                    //                                var directionsService = new google.maps.DirectionsService;
                    //                                var selectedMode = document.getElementById('mode').value;
                    //                                directionsService.route({
                    //                                    origin: startPoint,
                    //                                    destination: endPoint,
                    //                                    travelMode: google.maps.TravelMode[selectedMode]
                    //                                }, function (response, status) {
                    //                                    if (status == 'OK') {
                    //                                        directionsDisplay.setDirections(response);
                    //                                        var time = 0;
                    //                                        var myRoute = directionsDisplay.directions.routes[0];
                    //                                        for (var i = 0; i < myRoute.legs.length; i++) {
                    //                                            time += myRoute.legs[i].duration.value;
                    //                                        }
                    //                                        if (minTime > time) {
                    //                                            minTime = time;
                    //                                            minWayPoint = {
                    //                                                location: data[i].address,
                    //                                                stopover: false
                    //                                            }
                    //                                        }
                    //                                    }
                    //                                });
                    //                            }
                    //                        }
                    //                        wayPoints.push(minWayPoint);
                    //                    }

                    var startPoint = {
                        lat: markers[0].getPosition().lat(),
                        lng: markers[0].getPosition().lng()
                    }
                    var minTime = Number.MAX_VALUE;
                    var addresses = [];
                    var minWayPoint;
                    var endPoint;
                    var wayPoints = [];
                    var curr
                    while (recycleTypes.length > 0) {
                        var curr = recycleTypes.pop();
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].recycleOptions.indexOf(curr) != -1) {
                                minWayPoint = {
                                    location: data[i].address,
                                    stopover: false
                                }
                                break;
                            }
                        }
                        wayPoints.push(minWayPoint);
                    }

                    // END OF ALGO

                    var directionsDisplay = new google.maps.DirectionsRenderer;
                    var directionsService = new google.maps.DirectionsService;
                    var selectedMode = document.getElementById('mode').value;
                    directionsService.route({
                        origin: {
                            lat: markers[0].getPosition().lat(),
                            lng: markers[0].getPosition().lng()
                        }, // Haight.
                        destination: {
                            lat: markers[1].getPosition().lat(),
                            lng: markers[1].getPosition().lng()
                        },
                        waypoints: wayPoints,
                        travelMode: google.maps.TravelMode[selectedMode]
                    }, function (response, status) {
                        if (status == 'OK') {
                            directionsDisplay.setDirections(response);
                            if (lastDirection != null) {
                                lastDirection.setMap(null);
                            }
                            directionsDisplay.setMap(map);
                            lastDirection = directionsDisplay;
                            var time = 0;
                            var myRoute = directionsDisplay.directions.routes[0];
                            for (var i = 0; i < myRoute.legs.length; i++) {
                                time += myRoute.legs[i].duration.text;
                            }
                            sweetAlert("Master!", "time of route: " + time, "success");
                            // alert(time);
                        } else { //
                            sweetAlert("Oops...", 'Directions request failed due to ' + status, "error");
                            // window.alert('Directions request failed due to ' + status);
                        }
                    });
                }
            });
        }

        function geocodeLatLngMe(geocoder, map, latlng) {

            //            var latlngStr = input.split(',', 2);
            //            var latlng = {
            //                lat: parseFloat(latlngStr[0]),
            //                lng: parseFloat(latlngStr[1])
            //            };
            geocoder.geocode({
                'location': latlng
            }, function (results, status) {
                if (status === 'OK') {
                    if (results[1]) {
                        map.setZoom(11);
                        var image = {
                            url: '../images/me.png',
                            size: new google.maps.Size(70, 70),
                        };
                        var marker = new google.maps.Marker({
                            position: latlng,
                            map: map,
                            icon: image
                        });
                        marker.setMap(map);
                        // markersAmir.push(marker);
                        var input = document.getElementById('fromSearch');
                        input.value = results[0].formatted_address;
                    } else {
                        sweetAlert("Oops...", "Something went wrong!", "error");
                        //window.alert('No results found');
                    }
                } else {
                    //                    window.alert('Geocoder failed due to: ' + status);
                }
            });
        }

        function geocodeLatLngToAdressSecondSearch(geocoder, map, latlng) {
            geocoder.geocode({
                'location': latlng
            }, function (results, status) {
                if (status === 'OK') {
                    if (results[1]) {
                        var input = document.getElementById('fromSearch');
                        input.value = results[0].formatted_address;
                    } else {
                        //                        window.alert('No results found');
                        sweetAlert("Oops...", "Something went wrong!", "error");
                    }
                } else {
                    //                    window.alert('Geocoder failed due to: ' + status);
                }
            });
        }

        function geocodeLatLngToAdress(geocoder, map, latlng) {
            geocoder.geocode({
                'location': latlng
            }, function (results, status) {
                if (status === 'OK') {
                    if (results[1]) {
                        var input = document.getElementById('endSearch');
                        input.value = results[0].formatted_address;
                    } else {
                        //window.alert('No results found');
                        sweetAlert("Oops...", "Something went wrong!", "error");
                    }
                } else {
                    //                    window.alert('Geocoder failed due to: ' + status);
                }
            });
        }

        function printStations(resultMap) {
            for (var indexStations = 0; indexStations < stations.length; indexStations++) {
                var position = {
                    lat: stations[indexStations].latitue,
                    lng: stations[indexStations].longitude
                };
                var image = {
                    url: '../images/greenMarker.png',
                    size: new google.maps.Size(70, 70),
                };
                resultMap.setCenter(position);
                var marker = new google.maps.Marker({
                    map: resultMap,
                    position: position,
                    icon: image
                });
                markersAllStations.push(marker);
            }
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc1vF1JIadQUm1MazIp9XCtqj2uMfwnk8&&libraries=places&callback=initMap">
    </script>
    <script src="js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.0-rc.2/angular.min.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/searchController.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>

</body>

</html>